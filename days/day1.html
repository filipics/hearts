<div id="day1" class="section">
    <div class="day-header">
        <h2>üá´üá∑ Mi√©rcoles 7 de Enero</h2>
        <p>Dynamic Itinerary ‚Ä¢ Drag & Drop to Reorder ‚Ä¢ Live Walking Route</p>
    </div>

    <!-- 1. STATS HEADER (Dynamic) -->
    <div class="day-stats-header">
        <div class="stat-pill">
            <i class="fas fa-clock"></i>
            <span id="total-time">0h</span>
            <small>Total</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-walking"></i>
            <span id="total-dist">Calc...</span>
            <small>Walking</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-euro-sign"></i>
            <span>~95‚Ç¨</span>
            <small>Est. Cost</small>
        </div>
    </div>

    <!-- 2. INTERACTIVE MAP -->
    <div class="interactive-map-container">
        <div id="map-day1"></div>
    </div>

    <!-- RAIN TOGGLE -->
    <div class="day-rain-toggle">
        <label onclick="toggleRainMode()">
            <i class="fas fa-cloud-rain"></i>
            <span>¬øLlueve hoy? Ver alternativas</span>
        </label>
        <div class="rain-switch" id="rainSwitch1" onclick="toggleRainMode()"></div>
    </div>

    <!-- 3. REORDERABLE ACTIVITY GRID -->
    <div id="activityGridDay1" class="activity-grid">
        
        <!-- ITEM 1: LLEGADA (Fixed Start) -->
        <div class="activity-block" data-id="arrival" data-duration="90" data-lat="48.8569" data-lng="2.3582" data-fixed="true">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">08:00 - 09:30</span>
                <div class="activity-icon-badge"><i class="fas fa-plane"></i></div>
            </div>
            <div class="activity-block-title">Llegada & Transfer</div>
            <div class="activity-block-subtitle">CDG ‚Üí Hotel (90 min)</div>
            <div class="activity-details-container">
                <div class="detail-box">
                    <i class="fas fa-info-circle"></i>
                    <div class="detail-content">
                        <div class="detail-value">Check-in / Bag Drop</div>
                        <div class="detail-note">H√¥tel Caron de Beaumarchais</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ITEM: NOTRE DAME -->
        <div class="activity-block" data-id="notre-dame" data-duration="75" data-lat="48.8529" data-lng="2.3500">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-church"></i></div>
            </div>
            <div class="activity-block-title">Notre Dame</div>
            <div class="activity-block-subtitle">Exterior Visit (75 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Caminata por √éle de la Cit√©.</p>
            </div>
        </div>

        <!-- ITEM: SAINTE CHAPELLE -->
        <div class="activity-block" data-id="sainte-chapelle" data-duration="60" data-lat="48.8554" data-lng="2.3450">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-gem"></i></div>
            </div>
            <div class="activity-block-title">Sainte-Chapelle</div>
            <div class="activity-block-subtitle">Vitrales (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reserva necesaria. 13‚Ç¨.</p>
            </div>
        </div>

        <!-- ITEM: LUNCH (GENERIC) -->
        <div class="activity-block" data-id="lunch" data-duration="60" data-lat="48.8574" data-lng="2.3591">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display" style="background:#EC4899;">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-utensils"></i></div>
            </div>
            <div class="activity-block-title">Almuerzo</div>
            <div class="activity-block-subtitle">Tiempo Libre (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Hora libre para comer por la zona. Sugerencia: Le Marais.</p>
            </div>
        </div>

        <!-- ITEM: PANTHEON -->
        <div class="activity-block" data-id="pantheon" data-duration="60" data-lat="48.8462" data-lng="2.3464">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-monument"></i></div>
            </div>
            <div class="activity-block-title">Panth√©on</div>
            <div class="activity-block-subtitle">Visita (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Tumbas de Voltaire, Rousseau, Curie.</p>
            </div>
        </div>

        <!-- ITEM: SHAKESPEARE -->
        <div class="activity-block" data-id="shakespeare" data-duration="30" data-lat="48.8519" data-lng="2.3470">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-book"></i></div>
            </div>
            <div class="activity-block-title">Shakespeare & Co</div>
            <div class="activity-block-subtitle">Librer√≠a (30 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Librer√≠a hist√≥rica frente a Notre Dame.</p>
            </div>
        </div>

        <!-- ITEM: PETIT PALAIS -->
        <div class="activity-block" data-id="petit-palais" data-duration="60" data-lat="48.8661" data-lng="2.3144">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-palette"></i></div>
            </div>
            <div class="activity-block-title">Petit Palais</div>
            <div class="activity-block-subtitle">Museo (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Gratis. Colecci√≥n permanente y edificio.</p>
            </div>
        </div>

        <!-- ITEM: PASSAGE PANORAMAS -->
        <div class="activity-block" data-id="panoramas" data-duration="45" data-lat="48.8714" data-lng="2.3424">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-store"></i></div>
            </div>
            <div class="activity-block-title">Passage Panoramas</div>
            <div class="activity-block-subtitle">Paseo (45 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Galer√≠a cubierta ideal para el fr√≠o.</p>
            </div>
        </div>

        <!-- ITEM: GALERIES LAFAYETTE -->
        <div class="activity-block" data-id="lafayette" data-duration="60" data-lat="48.8737" data-lng="2.3322">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-shopping-bag"></i></div>
            </div>
            <div class="activity-block-title">Galeries Lafayette</div>
            <div class="activity-block-subtitle">Rooftop (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Vistas gratis y c√∫pula.</p>
            </div>
        </div>

        <!-- ITEM: LOUVRE -->
        <div class="activity-block" data-id="louvre" data-duration="120" data-lat="48.8606" data-lng="2.3376">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-paint-brush"></i></div>
            </div>
            <div class="activity-block-title">Louvre Nocturno</div>
            <div class="activity-block-subtitle">Museo (2h)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Abierto hasta tarde los mi√©rcoles.</p>
            </div>
        </div>

    </div>
    
    <div style="height: 100px;"></div>

    <script>
        // --- VARIABLES ---
        let map;
        let routeControl;
        const grid = document.getElementById('activityGridDay1');

        // --- INIT ---
        setTimeout(() => {
            initMap();
            initSortable();
            updateScheduleAndRoute(); // Initial calculation
        }, 100);

        // --- 1. SCHEDULE LOGIC ---
        function updateScheduleAndRoute() {
            const blocks = Array.from(grid.children);
            let currentTime = 8 * 60; // Start at 08:00 AM (in minutes)
            let waypoints = [];

            // Reset loop
            blocks.forEach(block => {
                const duration = parseInt(block.dataset.duration) || 60;
                const lat = parseFloat(block.dataset.lat);
                const lng = parseFloat(block.dataset.lng);
                
                // Add to map waypoints if valid
                if (!isNaN(lat) && !isNaN(lng)) {
                    waypoints.push(L.latLng(lat, lng));
                }

                // Calculate Times
                const startH = Math.floor(currentTime / 60);
                const startM = currentTime % 60;
                
                currentTime += duration;
                
                const endH = Math.floor(currentTime / 60);
                const endM = currentTime % 60;

                // Format
                const timeStr = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')} - ${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                
                // Update DOM
                const badge = block.querySelector('.time-display');
                if(badge) badge.innerText = timeStr;

                // Add travel time buffer (e.g., 20 min between activities)
                // We're keeping it simple: Activity time assumes travel time is handled or part of the flow
                // But normally you'd add travel time here. For now, we chain them directly.
                currentTime += 15; // Adding 15min travel buffer between blocks automatically
            });

            // Update Map Route
            updateRoute(waypoints);
            
            // Update Total Time
            const endH = Math.floor(currentTime / 60);
            const totalHours = endH - 8;
            document.getElementById('total-time').innerText = `~${totalHours}h`;
        }

        // --- 2. MAP LOGIC (OSRM Routing) ---
        function initMap() {
            const mapContainer = document.getElementById('map-day1');
            if (mapContainer && !mapContainer._leaflet_id) {
                map = L.map('map-day1').setView([48.8566, 2.3522], 13);
                
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    maxZoom: 20
                }).addTo(map);
            }
        }

        function updateRoute(waypoints) {
            if (!map) return;

            // Clear previous route
            if (routeControl) {
                map.removeControl(routeControl);
            }

            // Create new route
            // We use L.Routing.control but hide the text instructions container
            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                show: false, // Hide the instructions panel
                createMarker: function(i, wp, nWps) {
                    // Custom markers for stops (Numbered)
                    return L.marker(wp.latLng, {
                        draggable: false,
                        icon: L.divIcon({
                            className: 'custom-map-marker',
                            html: `<div style="background-color:#0A2540; color:white; border-radius:50%; width:24px; height:24px; text-align:center; line-height:24px; font-weight:bold; border:2px solid white; box-shadow:0 2px 5px rgba(0,0,0,0.3);">${i+1}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        })
                    }).bindPopup(`Stop ${i+1}`);
                },
                lineOptions: {
                    styles: [{color: '#00D4FF', opacity: 0.8, weight: 6}]
                },
                fitSelectedRoutes: true,
                addWaypoints: false // Disable adding points by clicking line
            }).addTo(map);
            
            // Hide the default container that Leaflet Routing Machine adds
            // We only want the visual line on the map
            const container = document.querySelector('.leaflet-routing-container');
            if (container) container.style.display = 'none';
        }

        // --- 3. SORTABLE LOGIC ---
        function initSortable() {
            if (grid) {
                new Sortable(grid, {
                    animation: 150,
                    handle: '.activity-block', // Drag whole block
                    ghostClass: 'sortable-ghost',
                    onEnd: function() {
                        updateScheduleAndRoute(); // Recalculate on drop
                    }
                });
            }
        }

        // Helper
        window.toggleDetails = function(btn) {
            const container = btn.nextElementSibling;
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                btn.innerHTML = 'Ver menos <i class="fas fa-chevron-up"></i>';
            } else {
                btn.innerHTML = 'Ver detalles <i class="fas fa-chevron-down"></i>';
            }
        };
    </script>
</div>
