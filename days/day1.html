<div id="day1" class="section">
    <div class="day-header">
        <h2>ðŸ‡«ðŸ‡· MiÃ©rcoles 7 de Enero</h2>
        <p>Dynamic Itinerary â€¢ Live Route â€¢ Drag & Drop</p>
    </div>

    <!-- 1. STATS HEADER -->
    <div class="day-stats-header">
        <div class="stat-pill">
            <i class="fas fa-clock"></i>
            <span id="total-time">0h</span>
            <small>Total</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-walking"></i>
            <span id="total-dist">Calc...</span>
            <small>Walking</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-euro-sign"></i>
            <span>~$133</span>
            <small>Hotel Cost p/p</small>
        </div>
    </div>

    <!-- 2. INTERACTIVE MAP -->
    <div class="interactive-map-container" id="mapContainerDay1">
        <div id="map-day1"></div>
        <button class="map-expand-btn" onclick="toggleMapSize()" title="Expandir mapa">
            <i class="fas fa-expand-alt"></i>
        </button>
    </div>

    <!-- RAIN TOGGLE -->
    <div class="day-rain-toggle">
        <label onclick="toggleRainMode()">
            <i class="fas fa-cloud-rain"></i>
            <span>Â¿Llueve hoy? Ver alternativas</span>
        </label>
        <div class="rain-switch" id="rainSwitch1" onclick="toggleRainMode()"></div>
    </div>

    <!-- 3. REORDERABLE ACTIVITY GRID -->
    <div id="activityGridDay1" class="activity-grid">
        
        <!-- ITEM 1: ARRIVAL -->
        <div class="activity-block" data-id="arrival" data-duration="90" data-lat="48.8569" data-lng="2.3582" data-name="Hotel (Start)">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">08:00 - 09:30</span>
                <div class="activity-icon-badge"><i class="fas fa-plane"></i></div>
            </div>
            <div class="activity-block-title">Llegada & Hotel</div>
            <div class="activity-block-subtitle">CDG â†’ Le Marais (90 min)</div>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Check-in / Bag Drop @ WYLD Saint Germain.</p>
            </div>
        </div>

        <!-- NOTRE DAME -->
        <div class="activity-block" data-id="notre-dame" data-duration="75" data-lat="48.8529" data-lng="2.3500" data-name="Notre Dame">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-church"></i></div>
            </div>
            <div class="activity-block-title">Notre Dame</div>
            <div class="activity-block-subtitle">Exterior (75 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Caminata por ÃŽle de la CitÃ©.</p>
            </div>
        </div>

        <!-- SAINTE CHAPELLE -->
        <div class="activity-block" data-id="sainte-chapelle" data-duration="60" data-lat="48.8554" data-lng="2.3450" data-name="Sainte-Chapelle">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-gem"></i></div>
            </div>
            <div class="activity-block-title">Sainte-Chapelle</div>
            <div class="activity-block-subtitle">Vitrales (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reserva 13â‚¬.</p>
            </div>
        </div>

        <!-- LUNCH (NO MAP COORDS) -->
        <div class="activity-block" data-id="lunch" data-duration="60" data-name="Almuerzo">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display" style="background:#EC4899;">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-utensils"></i></div>
            </div>
            <div class="activity-block-title">Almuerzo</div>
            <div class="activity-block-subtitle">Tiempo Libre (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Hora libre para comer. (No es parada de mapa)</p>
            </div>
        </div>

        <!-- PANTHEON -->
        <div class="activity-block" data-id="pantheon" data-duration="60" data-lat="48.8462" data-lng="2.3464" data-name="PanthÃ©on">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-monument"></i></div>
            </div>
            <div class="activity-block-title">PanthÃ©on</div>
            <div class="activity-block-subtitle">Visita (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Tumbas de Voltaire, Rousseau.</p>
            </div>
        </div>

        <!-- SHAKESPEARE -->
        <div class="activity-block" data-id="shakespeare" data-duration="30" data-lat="48.8519" data-lng="2.3470" data-name="Shakespeare & Co">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-book"></i></div>
            </div>
            <div class="activity-block-title">Shakespeare & Co</div>
            <div class="activity-block-subtitle">LibrerÃ­a (30 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">LibrerÃ­a histÃ³rica.</p>
            </div>
        </div>

        <!-- PETIT PALAIS -->
        <div class="activity-block" data-id="petit-palais" data-duration="60" data-lat="48.8661" data-lng="2.3144" data-name="Petit Palais">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-palette"></i></div>
            </div>
            <div class="activity-block-title">Petit Palais</div>
            <div class="activity-block-subtitle">Museo (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Gratis.</p>
            </div>
        </div>

        <!-- PASSAGE PANORAMAS -->
        <div class="activity-block" data-id="panoramas" data-duration="45" data-lat="48.8714" data-lng="2.3424" data-name="P. Panoramas">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-store"></i></div>
            </div>
            <div class="activity-block-title">Passage Panoramas</div>
            <div class="activity-block-subtitle">Paseo (45 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">GalerÃ­a cubierta.</p>
            </div>
        </div>

        <!-- GALERIES LAFAYETTE -->
        <div class="activity-block" data-id="lafayette" data-duration="60" data-lat="48.8737" data-lng="2.3322" data-name="Lafayette">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-shopping-bag"></i></div>
            </div>
            <div class="activity-block-title">Galeries Lafayette</div>
            <div class="activity-block-subtitle">Rooftop (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Vistas gratis.</p>
            </div>
        </div>

        <!-- LOUVRE -->
        <div class="activity-block" data-id="louvre" data-duration="120" data-lat="48.8606" data-lng="2.3376" data-name="Louvre">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-paint-brush"></i></div>
            </div>
            <div class="activity-block-title">Louvre Nocturno</div>
            <div class="activity-block-subtitle">Museo (2h)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Abierto tarde.</p>
            </div>
        </div>

        <!-- RETURN HOTEL -->
        <div class="activity-block" data-id="return-hotel" data-duration="30" data-lat="48.8569" data-lng="2.3582" data-name="Hotel (End)">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-bed"></i></div>
            </div>
            <div class="activity-block-title">Regreso al Hotel</div>
            <div class="activity-block-subtitle">Descanso</div>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Vuelta a Le Marais.</p>
            </div>
        </div>

    </div>
    
    <div style="height: 100px;"></div>

    <script>
        (function() {
        // --- VARIABLES ---
        let map;
        let routeControl;
        const grid = document.getElementById('activityGridDay1');
        const mapContainer = document.getElementById('mapContainerDay1');

        // --- INIT ---
        setTimeout(() => {
            initMap();
            initSortable();
            updateScheduleAndRoute(); 
        }, 100);

        // --- 1. SCHEDULE LOGIC ---
        function updateScheduleAndRoute() {
            const blocks = Array.from(grid.children);
            let currentTime = 8 * 60; // Start 08:00
            let waypoints = [];
            let totalDist = 0; // Approx distance

            blocks.forEach(block => {
                const duration = parseInt(block.dataset.duration) || 60;
                
                // Map Point Logic
                if (block.dataset.lat && block.dataset.lng) {
                    const lat = parseFloat(block.dataset.lat);
                    const lng = parseFloat(block.dataset.lng);
                    const name = block.dataset.name || "Stop";
                    waypoints.push({ latLng: L.latLng(lat, lng), name: name });
                }

                // Time Calculation
                const startH = Math.floor(currentTime / 60);
                const startM = currentTime % 60;
                
                currentTime += duration;
                
                const endH = Math.floor(currentTime / 60);
                const endM = currentTime % 60;

                const timeStr = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')} - ${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;
                
                const badge = block.querySelector('.time-display');
                if(badge) badge.innerText = timeStr;

                currentTime += 15; // Travel buffer
            });

            updateRoute(waypoints);
            
            const endH = Math.floor(currentTime / 60);
            const totalHours = endH - 8;
            document.getElementById('total-time').innerText = `~${totalHours}h`;
        }

        // --- 2. MAP LOGIC ---
        function initMap() {
            if (mapContainer && !document.getElementById('map-day1')._leaflet_id) {
                map = L.map('map-day1').setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'OSM',
                    maxZoom: 20
                }).addTo(map);
            }
        }

        function updateRoute(points) {
            if (!map) return;
            if (routeControl) map.removeControl(routeControl);

            const waypoints = points.map(p => p.latLng);

            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                show: false,
                createMarker: function(i, wp, nWps) {
                    const name = points[i].name;
                    return L.marker(wp.latLng, {
                        draggable: false,
                        icon: L.divIcon({
                            className: 'custom-map-marker',
                            html: `<div class="marker-pin"></div><div class="marker-label">${name}</div>`,
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        })
                    });
                },
                lineOptions: {
                    styles: [{color: '#00D4FF', opacity: 0.8, weight: 6}]
                },
                addWaypoints: false,
                fitSelectedRoutes: true
            }).addTo(map);

            // Listen for route found to update distance stats
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                // Convert meters to km
                const km = (summary.totalDistance / 1000).toFixed(1);
                const distEl = document.getElementById('total-dist');
                if(distEl) distEl.innerText = `${km} km`;
            });
        }

        // --- 3. SORTABLE ---
        function initSortable() {
            if (grid) {
                new Sortable(grid, {
                    animation: 150,
                    handle: '.activity-block',
                    ghostClass: 'sortable-ghost',
                    onEnd: function() { updateScheduleAndRoute(); }
                });
            }
        }

        // --- 4. MAP EXPAND ---
        window.toggleMapSize = function() {
            mapContainer.classList.toggle('expanded-map');
            setTimeout(() => {
                map.invalidateSize();
                // Re-fit bounds if expanded
                if(routeControl) {
                    // This is a bit hacky to re-center route
                    const waypoints = routeControl.getWaypoints();
                    // We just trigger a re-route calculation effectively or just let user zoom
                }
            }, 300);
        };

        window.toggleDetails = function(btn) {
            const container = btn.nextElementSibling;
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                btn.innerHTML = 'Ver menos <i class="fas fa-chevron-up"></i>';
            } else {
                btn.innerHTML = 'Ver detalles <i class="fas fa-chevron-down"></i>';
            }
        };
        })();
    </script>
</div>
