<div id="day5" class="section">
    <div class="day-header">
        <h2>ðŸ‡¬ðŸ‡§ SÃ¡bado 11 de Enero</h2>
        <p>London Day 2 â€¢ Westminster â€¢ Tower â€¢ Sky Garden â€¢ Covent Garden ðŸŒŸ</p>
    </div>

    <!-- 1. STATS HEADER -->
    <div class="day-stats-header">
        <div class="stat-pill">
            <i class="fas fa-clock"></i>
            <span id="total-time">0h</span>
            <small>Total</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-walking"></i>
            <span id="total-dist">Calc...</span>
            <small>Walking</small>
        </div>
        <div class="stat-pill">
            <i class="fas fa-euro-sign"></i>
            <span>$110</span>
            <small>Hotel</small>
        </div>
    </div>

    <!-- 2. INTERACTIVE MAP -->
    <div class="interactive-map-container" id="mapContainerDay5">
        <div id="map-day5"></div>
        <button class="map-expand-btn" onclick="toggleMapSize()" title="Expandir mapa">
            <i class="fas fa-expand-alt"></i>
        </button>
    </div>

    <!-- RAIN TOGGLE -->
    <div class="day-rain-toggle">
        <label onclick="toggleRainMode()">
            <i class="fas fa-cloud-rain"></i>
            <span>Â¿Llueve hoy? Ver alternativas techadas</span>
        </label>
        <div class="rain-switch" id="rainSwitch5" onclick="toggleRainMode()"></div>
    </div>

    <!-- REDDIT TIP BOX -->
    <div class="tip-box" style="background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); border-color: #F59E0B; margin-bottom: 20px;">
        <h4 style="color:#92400E;"><i class="fab fa-reddit"></i> London Reddit Consensus Day 2</h4>
        <p style="color:#78350F;">
            Iconic sights + FREE views:<br>
            âœ“ Westminster classics (Big Ben, Parliament)<br>
            âœ“ Tower Bridge (THE Instagram spot)<br>
            âœ“ Sky Garden (FREE reservation = best views in London!)<br>
            âœ“ Covent Garden & Neal's Yard (colorful & charming)<br><br>
            Reddit tip: Book Sky Garden reservation NOW - fills up fast!
        </p>
    </div>

    <!-- 3. REORDERABLE ACTIVITY GRID -->
    <div id="activityGridDay5" class="activity-grid">

        <!-- ITEM 1: WESTMINSTER WALK -->
        <div class="activity-block" data-id="westminster-walk" data-duration="90" data-lat="51.4994" data-lng="-0.1248" data-name="Westminster">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-landmark"></i></div>
            </div>
            <div class="activity-block-title">Westminster Walk</div>
            <div class="activity-block-subtitle">Big Ben, Parliament, Bridge (90 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Classic London - walk along Thames for great views. All exterior, completely free.</p>
            </div>
        </div>

        <!-- ITEM 2: BUCKINGHAM PALACE -->
        <div class="activity-block" data-id="buckingham-palace" data-duration="30" data-lat="51.5014" data-lng="-0.1419" data-name="Buckingham Palace">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-crown"></i></div>
            </div>
            <div class="activity-block-title">Buckingham Palace</div>
            <div class="activity-block-subtitle">Exterior photo stop (30 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Quick photo stop. Changing of Guard crowds aren't worth it - just exterior views.</p>
            </div>
        </div>

        <!-- ITEM 3: LUNCH NEAR TOWER -->
        <div class="activity-block" data-id="lunch-tower" data-duration="60" data-lat="51.5079" data-lng="-0.0760" data-name="Tower Hill Lunch">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-utensils"></i></div>
            </div>
            <div class="activity-block-title">Lunch near Tower Bridge</div>
            <div class="activity-block-subtitle">Pubs or cafÃ©s near Tower Hill (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Good options: Coppa Club (igloo pods), local pubs, St Katharine Docks area.</p>
            </div>
        </div>

        <!-- ITEM 4: TOWER BRIDGE -->
        <div class="activity-block" data-id="tower-bridge" data-duration="60" data-lat="51.5055" data-lng="-0.0754" data-name="Tower Bridge">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-bridge"></i></div>
            </div>
            <div class="activity-block-title">Tower Bridge & Tower</div>
            <div class="activity-block-subtitle">Exterior views (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: THE Instagram spot. Walk across bridge. Tower of London interior Â£33 not worth it.</p>
            </div>
        </div>

        <!-- ITEM 5: SKY GARDEN -->
        <div class="activity-block" data-id="sky-garden" data-duration="60" data-lat="51.5151" data-lng="-0.0817" data-name="Sky Garden">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-cloud"></i></div>
            </div>
            <div class="activity-block-title">Sky Garden</div>
            <div class="activity-block-subtitle">FREE 35th floor views (60 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit #1: FREE views beat London Eye! 360Â° views, gardens, bar. Book reservation 3 weeks in advance at sky-garden.london.</p>
            </div>
        </div>

        <!-- ITEM 6: LEADENHALL MARKET -->
        <div class="activity-block" data-id="leadenhall-market" data-duration="20" data-lat="51.5133" data-lng="-0.0834" data-name="Leadenhall Market">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-store"></i></div>
            </div>
            <div class="activity-block-title">Leadenhall Market</div>
            <div class="activity-block-subtitle">Victorian covered market (20 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Beautiful Victorian architecture. Used as Diagon Alley in Harry Potter films.</p>
            </div>
        </div>

        <!-- ITEM 7: COVENT GARDEN -->
        <div class="activity-block" data-id="covent-garden" data-duration="105" data-lat="51.5129" data-lng="-0.1240" data-name="Covent Garden">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-theater-masks"></i></div>
            </div>
            <div class="activity-block-title">Covent Garden & Neal's Yard</div>
            <div class="activity-block-subtitle">Covered market & colorful alley (105 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Charming covered market, street performers. Neal's Yard = colorful hidden alley.</p>
            </div>
        </div>

        <!-- ITEM 8: DAUNT BOOKS -->
        <div class="activity-block" data-id="daunt-books" data-duration="20" data-lat="51.5195" data-lng="-0.1519" data-name="Daunt Books">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-book"></i></div>
            </div>
            <div class="activity-block-title">Daunt Books Marylebone</div>
            <div class="activity-block-subtitle">Beautiful Edwardian bookstore (20 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Most beautiful bookshop in London. Stained glass, cozy reading nooks.</p>
            </div>
        </div>

        <!-- ITEM 9: GORDON'S WINE BAR -->
        <div class="activity-block" data-id="gordons-wine-bar" data-duration="40" data-lat="51.5071" data-lng="-0.1238" data-name="Gordon's Wine Bar">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-wine-glass"></i></div>
            </div>
            <div class="activity-block-title">Gordon's Wine Bar</div>
            <div class="activity-block-subtitle">Historic 1890 candlelit wine bar (40 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Reddit: Oldest wine bar in London. Atmospheric vaulted cellars, great wine selection.</p>
            </div>
        </div>

        <!-- ITEM 10: FINAL DINNER -->
        <div class="activity-block" data-id="final-dinner" data-duration="90" data-name="Final Dinner">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-utensils"></i></div>
            </div>
            <div class="activity-block-title">Final London Dinner</div>
            <div class="activity-block-subtitle">Last meal in London (90 min)</div>
            <button class="expand-btn" onclick="toggleDetails(this)">Ver detalles <i class="fas fa-chevron-down"></i></button>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Good options: Dishoom (Indian), Flat Iron steak (American), The Ivy Market Grill (British). Last chance for British cuisine! Try afternoon tea at Fortnum & Mason if time allows.</p>
            </div>
        </div>

        <!-- RETURN HOTEL -->
        <div class="activity-block" data-id="return-hotel" data-duration="30" data-lat="51.5155" data-lng="-0.0922" data-name="Hotel (End)">
            <div class="activity-block-header">
                <span class="activity-time-badge time-display">--:--</span>
                <div class="activity-icon-badge"><i class="fas fa-bed"></i></div>
            </div>
            <div class="activity-block-title">Regreso al Hotel</div>
            <div class="activity-block-subtitle">South Kensington</div>
            <div class="activity-details-container">
                <p style="font-size:0.85rem;">Vuelta al hotel The Z Trafalgar. Pack for tomorrow's flight to Paris.</p>
            </div>
        </div>

    </div>

    <script>
    (function() {
        // --- VARIABLES ---
        let map;
        let routeControl;
        const grid = document.getElementById('activityGridDay5');
        const mapContainer = document.getElementById('mapContainerDay5');

        // --- INIT ---
        setTimeout(() => {
            initMap();
            initSortable();
            updateScheduleAndRoute();
        }, 100);

        // --- 1. SCHEDULE LOGIC ---
        function updateScheduleAndRoute() {
            const blocks = Array.from(grid.children);
            let currentTime = 10 * 60; // Start 10:00 AM
            let waypoints = [];
            let totalDist = 0; // Approx distance

            blocks.forEach(block => {
                const duration = parseInt(block.dataset.duration) || 60;

                // Map Point Logic
                if (block.dataset.lat && block.dataset.lng) {
                    const lat = parseFloat(block.dataset.lat);
                    const lng = parseFloat(block.dataset.lng);
                    const name = block.dataset.name || "Stop";
                    waypoints.push({ latLng: L.latLng(lat, lng), name: name });
                }

                // Time Calculation
                const startH = Math.floor(currentTime / 60);
                const startM = currentTime % 60;

                currentTime += duration;

                const endH = Math.floor(currentTime / 60);
                const endM = currentTime % 60;

                const timeStr = `${String(startH).padStart(2,'0')}:${String(startM).padStart(2,'0')} - ${String(endH).padStart(2,'0')}:${String(endM).padStart(2,'0')}`;

                const badge = block.querySelector('.time-display');
                if(badge) badge.innerText = timeStr;

                currentTime += 15; // Travel buffer
            });

            updateRoute(waypoints);

            const endH = Math.floor(currentTime / 60);
            const totalHours = endH - 10;
            document.getElementById('total-time').innerText = `~${totalHours}h`;
        }

        // --- 2. MAP LOGIC ---
        function initMap() {
            if (mapContainer && !document.getElementById('map-day5')._leaflet_id) {
                map = L.map('map-day5').setView([51.5074, -0.1278], 12);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    attribution: 'OSM',
                    maxZoom: 20
                }).addTo(map);
            }
        }

        function updateRoute(points) {
            if (!map) return;
            if (routeControl) map.removeControl(routeControl);

            const waypoints = points.map(p => p.latLng);

            routeControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                show: false,
                createMarker: function(i, wp, nWps) {
                    const name = points[i].name;
                    return L.marker(wp.latLng, {
                        draggable: false,
                        icon: L.divIcon({
                            className: 'custom-map-marker',
                            html: `<div class="marker-pin"></div><div class="marker-label">${name}</div>`,
                            iconSize: [30, 42],
                            iconAnchor: [15, 42]
                        })
                    });
                },
                lineOptions: {
                    styles: [{color: '#00D4FF', opacity: 0.8, weight: 6}]
                },
                addWaypoints: false,
                fitSelectedRoutes: true
            }).addTo(map);

            // Listen for route found to update distance stats
            routeControl.on('routesfound', function(e) {
                const routes = e.routes;
                const summary = routes[0].summary;
                // Convert meters to km
                const km = (summary.totalDistance / 1000).toFixed(1);
                const distEl = document.getElementById('total-dist');
                if(distEl) distEl.innerText = `${km} km`;
            });
        }

        // --- 3. SORTABLE ---
        function initSortable() {
            if (grid) {
                new Sortable(grid, {
                    animation: 150,
                    handle: '.activity-block',
                    ghostClass: 'sortable-ghost',
                    onEnd: function() { updateScheduleAndRoute(); }
                });
            }
        }

        // --- 4. MAP EXPAND ---
        window.toggleMapSize = function() {
            mapContainer.classList.toggle('expanded-map');
            setTimeout(() => {
                map.invalidateSize();
                // Re-fit bounds if expanded
                if(routeControl) {
                    // This is a bit hacky to re-center route
                    const waypoints = routeControl.getWaypoints();
                    // We just trigger a re-route calculation effectively or just let user zoom
                }
            }, 300);
        };

        window.toggleDetails = function(btn) {
            const container = btn.nextElementSibling;
            container.classList.toggle('open');
            if (container.classList.contains('open')) {
                btn.innerHTML = 'Ver menos <i class="fas fa-chevron-up"></i>';
            } else {
                btn.innerHTML = 'Ver detalles <i class="fas fa-chevron-down"></i>';
            }
        };
    })();
    </script>
</div>